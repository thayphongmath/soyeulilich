<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªá th·ªëng giao b√†i t·∫≠p</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f9;
    }

    #adminPanel,
    #infoPanel,
    #examPanel {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #infoPanel,
    #examPanel {
      display: none;
    }

    #examPanel {
      height: 100vh;
      flex-direction: column;
    }

    #pdf-container {
      flex: 9;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }

    #pdfFrame {
      width: 100%;
      height: 100%;
      border: none;
    }

    #answer-bar {
      flex: 1;
      background: #fff;
      border-top: 2px solid #ccc;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }

    #question {
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .options-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      width: 100%;
    }

    .center-options {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-grow: 1;
    }

    .square {
      width: 50px;
      height: 50px;
      border: 2px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      user-select: none;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .square:hover {
      background: #e0e0e0;
    }

    .square.selected {
      background: #4caf50;
      color: white;
      border-color: #4caf50;
    }

    .short-answer input {
      width: 60px;
      height: 40px;
      font-size: 16px;
      text-align: center;
      border: 2px solid #333;
      border-radius: 4px;
      margin: 0 5px;
    }

    button {
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background: #2196f3;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #1976d2;
    }

    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    #shareLink {
      margin-top: 15px;
      font-weight: bold;
      color: #2e7d32;
    }

    .error {
      color: red;
      margin-top: 10px;
    }

    textarea {
      width: 100%;
      height: 150px;
    }

    @media (max-width: 600px) {
      .square {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }

      .short-answer input {
        width: 50px;
        height: 35px;
        font-size: 14px;
      }

      button {
        padding: 6px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>

  <!-- Giao di·ªán Admin -->
  <div id="adminPanel">
    <h2>T·∫°o b√†i t·∫≠p</h2>
    <div>
      <label>Link PDF (Google Drive): </label><br>
      <input id="pdfLink" size="60" placeholder="D√°n link Google Drive PDF..." required><br><br>
      <label>S·ªë c√¢u Tr·∫Øc nghi·ªám: </label>
      <input id="numMCQ" type="number" value="1" min="0"><br>
      <label>ƒêi·ªÉm cho Tr·∫Øc nghi·ªám (t·ªïng 10 ƒëi·ªÉm): </label>
      <input id="pointsMCQ" type="number" step="0.5" value="3" min="0"><br><br>
      <label>S·ªë c√¢u ƒê√∫ng/Sai: </label>
      <input id="numTF" type="number" value="1" min="0"><br>
      <label>ƒêi·ªÉm cho ƒê√∫ng/Sai: </label>
      <input id="pointsTF" type="number" step="0.5" value="3" min="0"><br><br>
      <label>S·ªë c√¢u Tr·∫£ l·ªùi ng·∫Øn: </label>
      <input id="numShort" type="number" value="1" min="0"><br>
      <label>ƒêi·ªÉm cho Tr·∫£ l·ªùi ng·∫Øn: </label>
      <input id="pointsShort" type="number" step="0.5" value="4" min="0"><br><br>
      <label>ƒê√°p √°n ƒë√∫ng (m·ªôt d√≤ng m·ªói c√¢u, v√≠ d·ª•):</label><br>
      <textarea id="correctAnswers"
        placeholder="1.A\n2.B\n3.DSSS\n4.DDDD\n5.2,43\n6.2025"></textarea><br><br>
      <label>Th·ªùi gian l√†m b√†i (ph√∫t): </label>
      <input id="timeLimit" type="number" value="30" min="1"><br><br>
      <label>S·ªë l·∫ßn l√†m b√†i t·ªëi ƒëa: </label>
      <input id="maxAttempts" type="number" value="1" min="1"><br><br>
      <button onclick="createExam()">T·∫°o b√†i t·∫≠p</button>
      <div id="shareLink"></div>
      <div id="error" class="error"></div>
    </div>
  </div>

  <!-- Giao di·ªán ƒêƒÉng nh·∫≠p v√† Nh·∫≠p th√¥ng tin h·ªçc sinh -->
  <div id="infoPanel">
    <h2>ƒêƒÉng nh·∫≠p Google ƒë·ªÉ l√†m b√†i</h2>
    <div id="buttonDiv"></div>
    <div id="studentInfo" style="display:none;">
      <p>H·ªç v√† t√™n: <span id="studentName"></span></p>
      <p>Email: <span id="studentEmail"></span></p>
      <label>L·ªõp: <input id="studentClass" placeholder="Nh·∫≠p l·ªõp..." required></label><br><br>
      <button onclick="checkAndStartExam()">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
    </div>
    <div id="infoError" class="error"></div>
  </div>

  <!-- Giao di·ªán H·ªçc sinh -->
  <div id="examPanel">
    <div id="pdf-container">
      <iframe id="pdfFrame" title="PDF B√†i t·∫≠p"></iframe>
    </div>
    <div id="answer-bar">
      <div id="question"></div>
      <div class="options-row">
        <button id="backBtn">‚óÑ Quay l·∫°i</button>
        <div class="center-options" id="options"></div>
        <button id="nextBtn">Ti·∫øp ‚ñ∫</button>
      </div>
    </div>
  </div>

  <script>
    let questions = [];
    let answers = [];
    let current = 0;
    let startTime = null;
    let timerId = null;
    let studentName = '';
    let studentEmail = '';
    let sheetName = '';
    let timeLimit = 0;
    const APPS_SCRIPT_URL = 'YOUR_NEW_APPS_SCRIPT_URL'; // Thay b·∫±ng URL Apps Script m·ªõi
    const GOOGLE_CLIENT_ID = '510396691917-o4gt6e2nom76l9qdjsa4hegmtcp6775k.apps.googleusercontent.com';

    // Kh·ªüi t·∫°o Google Sign-In
    function initGoogleSignIn() {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementById("buttonDiv"),
        { theme: "outline", size: "large" }
      );
    }

    function handleCredentialResponse(response) {
      const responsePayload = parseJwt(response.credential);
      studentName = responsePayload.name;
      studentEmail = responsePayload.email;
      document.getElementById("studentName").innerText = studentName;
      document.getElementById("studentEmail").innerText = studentEmail;
      document.getElementById("buttonDiv").style.display = "none";
      document.getElementById("studentInfo").style.display = "block";
    }

    function parseJwt(token) {
      try {
        return JSON.parse(atob(token.split('.')[1]));
      } catch (e) {
        return null;
      }
    }

    // H√†m ki·ªÉm tra link PDF h·ª£p l·ªá
    function isValidPDFLink(link) {
      return link.includes("drive.google.com") && link.includes("/file/");
    }

    // H√†m chuy·ªÉn ƒë·ªïi link Google Drive sang ƒë·ªãnh d·∫°ng xem PDF
    function convertGoogleDriveLink(link) {
      if (link.includes("drive.google.com")) {
        const fileIdMatch = link.match(/\/d\/(.+?)\//);
        if (fileIdMatch && fileIdMatch[1]) {
          return `https://drive.google.com/file/d/${fileIdMatch[1]}/preview`;
        }
      }
      return link;
    }

    // Parse ƒë√°p √°n ƒë√∫ng
    function parseCorrectAnswers(inputStr, numMCQ, numTF, numShort) {
      const correct = {};
      const lines = inputStr.trim().split('\n').filter(line => line.trim() !== '');
      const totalQuestions = numMCQ + numTF + numShort;

      if (lines.length !== totalQuestions) {
        throw new Error(`S·ªë l∆∞·ª£ng ƒë√°p √°n (${lines.length}) kh√¥ng kh·ªõp v·ªõi s·ªë c√¢u h·ªèi (${totalQuestions})! Vui l√≤ng ki·ªÉm tra l·∫°i textarea.`);
      }

      lines.forEach((line, index) => {
        const parts = line.split('.');
        if (parts.length !== 2) {
          throw new Error(`ƒê√°p √°n c√¢u ${index + 1} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (ph·∫£i l√† "s·ªë.ƒë√°p_√°n")! D√≤ng: "${line}"`);
        }
        const qNum = parts[0].trim();
        const ansStr = parts[1].trim();

        if (!/^\d+$/.test(qNum) || parseInt(qNum) !== index + 1) {
          throw new Error(`S·ªë c√¢u h·ªèi t·∫°i d√≤ng ${index + 1} kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng theo th·ª© t·ª±! D√≤ng: "${line}"`);
        }

        if (index < numMCQ) {
          if (!['A', 'B', 'C', 'D'].includes(ansStr)) {
            throw new Error(`ƒê√°p √°n tr·∫Øc nghi·ªám c√¢u ${qNum} ph·∫£i l√† A, B, C ho·∫∑c D! D√≤ng: "${line}"`);
          }
          correct[qNum] = ansStr;
        } else if (index < numMCQ + numTF) {
          if (ansStr.length !== 4 || !/^[DS]{4}$/.test(ansStr)) {
            throw new Error(`ƒê√°p √°n ƒë√∫ng/sai c√¢u ${qNum} ph·∫£i c√≥ 4 k√Ω t·ª± D ho·∫∑c S! D√≤ng: "${line}"`);
          }
          correct[qNum] = {
            '√ù 1': ansStr[0],
            '√ù 2': ansStr[1],
            '√ù 3': ansStr[2],
            '√ù 4': ansStr[3]
          };
        } else {
          const answers = ansStr.split(',').map(item => item.trim()).filter(item => item !== '');
          if (answers.length > 4) {
            throw new Error(`ƒê√°p √°n tr·∫£ l·ªùi ng·∫Øn c√¢u ${qNum} kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 4 ƒë√°p √°n! D√≤ng: "${line}"`);
          }
          if (answers.length === 0) {
            throw new Error(`ƒê√°p √°n tr·∫£ l·ªùi ng·∫Øn c√¢u ${qNum} kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng! D√≤ng: "${line}"`);
          }
          correct[qNum] = answers;
        }
      });
      return correct;
    }

    // Admin: T·∫°o b√†i t·∫≠p
    async function createExam() {
      const pdfLink = document.getElementById("pdfLink").value.trim();
      const numMCQ = parseInt(document.getElementById("numMCQ").value) || 0;
      const numTF = parseInt(document.getElementById("numTF").value) || 0;
      const numShort = parseInt(document.getElementById("numShort").value) || 0;
      const pointsMCQ = parseFloat(document.getElementById("pointsMCQ").value) || 0;
      const pointsTF = parseFloat(document.getElementById("pointsTF").value) || 0;
      const pointsShort = parseFloat(document.getElementById("pointsShort").value) || 0;
      const correctInput = document.getElementById("correctAnswers").value.trim();
      const timeLimitInput = parseInt(document.getElementById("timeLimit").value) || 30;
      const maxAttemptsInput = parseInt(document.getElementById("maxAttempts").value) || 1;
      const errorDiv = document.getElementById("error");

      try {
        if (!pdfLink || !isValidPDFLink(pdfLink)) {
          throw new Error("Vui l√≤ng nh·∫≠p link PDF h·ª£p l·ªá t·ª´ Google Drive!");
        }
        if (numMCQ + numTF + numShort === 0) {
          throw new Error("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt c√¢u h·ªèi!");
        }
        if (pointsMCQ + pointsTF + pointsShort !== 10) {
          throw new Error("T·ªïng ƒëi·ªÉm c√°c ph·∫ßn ph·∫£i b·∫±ng 10!");
        }

        const correctAnswers = parseCorrectAnswers(correctInput, numMCQ, numTF, numShort);

        questions = [];
        let counter = 1;
        for (let i = 0; i < numMCQ; i++) {
          questions.push({
            type: "mcq",
            text: `C√¢u ${counter++}: Tr·∫Øc nghi·ªám`,
            options: ["A", "B", "C", "D"]
          });
        }
        for (let i = 0; i < numTF; i++) {
          questions.push({
            type: "truefalse",
            text: `C√¢u ${counter++}: ƒê√∫ng/Sai`,
            options: ["√ù 1", "√ù 2", "√ù 3", "√ù 4"]
          });
        }
        for (let i = 0; i < numShort; i++) {
          questions.push({
            type: "short",
            text: `C√¢u ${counter++}: Tr·∫£ l·ªùi ng·∫Øn`
          });
        }

        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create_exam',
            questions: questions,
            correctAnswers: correctAnswers,
            point_alloc: { mcq: pointsMCQ, tf: pointsTF, short: pointsShort },
            time_limit: timeLimitInput,
            max_attempts: maxAttemptsInput
          })
        });
        const result = await response.json();
        if (result.status === 'success') {
          const examData = {
            pdfLink: convertGoogleDriveLink(pdfLink),
            questions,
            sheetName: result.sheetName,
            timeLimit: timeLimitInput
          };
          const examId = "exam" + Date.now();
          localStorage.setItem(examId, JSON.stringify(examData));

          const shareURL = window.location.origin + window.location.pathname + "?exam=" + examId;
          document.getElementById("shareLink").innerHTML =
            `üìå Link cho h·ªçc sinh: <a href="${shareURL}" target="_blank">${shareURL}</a>`;
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        errorDiv.innerText = `L·ªói: ${error.message}`;
      }
    }

    // Ki·ªÉm tra v√† b·∫Øt ƒë·∫ßu exam
    async function checkAndStartExam() {
      const studentClass = document.getElementById("studentClass").value.trim();
      const infoError = document.getElementById("infoError");

      if (!studentClass) {
        infoError.innerText = "Vui l√≤ng nh·∫≠p l·ªõp!";
        return;
      }

      try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=get_attempts&sheetName=${sheetName}&email=${studentEmail}`);
        const result = await response.json();
        if (result.allowed) {
          infoError.innerText = "";
          document.getElementById("infoPanel").style.display = "none";
          document.getElementById("examPanel").style.display = "flex";
          startTime = new Date();
          timerId = setTimeout(submitExam, timeLimit * 60000);
          current = 0;
          renderQuestion();
        } else {
          infoError.innerText = "B·∫°n ƒë√£ v∆∞·ª£t qu√° s·ªë l·∫ßn l√†m b√†i cho ph√©p!";
        }
      } catch (error) {
        infoError.innerText = `L·ªói: ${error.message}`;
      }
    }

    // H·ªçc sinh: Hi·ªÉn th·ªã c√¢u h·ªèi
    function renderQuestion() {
      const q = questions[current];
      document.getElementById("question").innerText = q.text;
      const container = document.getElementById("options");
      container.innerHTML = "";

      if (q.type === "mcq") {
        q.options.forEach((opt) => {
          const div = document.createElement("div");
          div.className = "square";
          div.innerText = opt;
          if (answers[current] === opt) div.classList.add("selected");
          div.onclick = () => {
            container.querySelectorAll(".square").forEach(sq => sq.classList.remove("selected"));
            div.classList.add("selected");
            answers[current] = opt;
            saveAnswers();
          };
          container.appendChild(div);
        });
      } else if (q.type === "truefalse") {
        q.options.forEach((opt) => {
          const group = document.createElement("div");
          group.style.display = "flex";
          group.style.alignItems = "center";
          group.style.gap = "6px";

          const label = document.createElement("span");
          label.innerText = opt + ":";
          group.appendChild(label);

          ["ƒê", "S"].forEach(choice => {
            const div = document.createElement("div");
            div.className = "square";
            div.innerText = choice;
            if (answers[current] && answers[current][opt] === choice) div.classList.add("selected");
            div.onclick = () => {
              group.querySelectorAll(".square").forEach(sq => sq.classList.remove("selected"));
              div.classList.add("selected");
              if (!answers[current]) answers[current] = {};
              answers[current][opt] = choice;
              saveAnswers();
            };
            group.appendChild(div);
          });

          container.appendChild(group);
        });
      } else if (q.type === "short") {
        const wrapper = document.createElement("div");
        wrapper.className = "short-answer";
        for (let i = 0; i < 4; i++) {
          const input = document.createElement("input");
          input.value = answers[current]?.[i] || "";
          input.oninput = () => {
            if (!answers[current]) answers[current] = [];
            answers[current][i] = input.value;
            saveAnswers();
          };
          wrapper.appendChild(input);
        }
        container.appendChild(wrapper);
      }

      document.getElementById("backBtn").disabled = current === 0;
      document.getElementById("nextBtn").innerText = current === questions.length - 1 ? "N·ªôp b√†i" : "Ti·∫øp ‚ñ∫";
    }

    // L∆∞u ƒë√°p √°n v√†o localStorage
    function saveAnswers() {
      const urlParams = new URLSearchParams(window.location.search);
      const examId = urlParams.get("exam");
      if (examId) {
        localStorage.setItem(`answers_${examId}`, JSON.stringify(answers));
      }
    }

    // T·∫£i ƒë√°p √°n ƒë√£ l∆∞u
    function loadAnswers() {
      const urlParams = new URLSearchParams(window.location.search);
      const examId = urlParams.get("exam");
      if (examId) {
        const savedAnswers = localStorage.getItem(`answers_${examId}`);
        if (savedAnswers) {
          answers = JSON.parse(savedAnswers);
        }
      }
    }

    // Chuy·ªÉn c√¢u h·ªèi ti·∫øp theo ho·∫∑c n·ªôp b√†i
    function nextQuestion() {
      if (current < questions.length - 1) {
        current++;
        renderQuestion();
      } else {
        submitExam();
      }
    }

    // Quay l·∫°i c√¢u h·ªèi tr∆∞·ªõc
    function prevQuestion() {
      if (current > 0) {
        current--;
        renderQuestion();
      }
    }

    // N·ªôp b√†i: T√≠nh to√°n v√† g·ª≠i ƒë·∫øn Google Sheets
    async function submitExam() {
      clearTimeout(timerId);
      const endTime = new Date();
      const timeTaken = Math.round((endTime - startTime) / 60000);
      const studentClass = document.getElementById("studentClass").value.trim();

      try {
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'submit',
            name: studentName,
            email: studentEmail,
            class: studentClass,
            timeTaken: timeTaken + ' ph√∫t',
            answers: answers,
            sheetName: sheetName
          })
        });

        const result = await response.json();
        if (result.status === 'success') {
          alert(`N·ªôp b√†i th√†nh c√¥ng!\nTh·ªùi gian: ${timeTaken} ph√∫t\nƒêi·ªÉm: ${result.score}`);
        } else {
          alert(`L·ªói: ${result.message}`);
        }
      } catch (error) {
        alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
      }
    }

    // G√°n s·ª± ki·ªán cho n√∫t
    document.getElementById("backBtn").onclick = prevQuestion;
    document.getElementById("nextBtn").onclick = nextQuestion;

    // Ki·ªÉm tra ch·∫ø ƒë·ªô h·ªçc sinh khi t·∫£i trang
    const urlParams = new URLSearchParams(window.location.search);
    const examId = urlParams.get("exam");
    if (examId) {
      const examData = JSON.parse(localStorage.getItem(examId));
      if (examData) {
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("infoPanel").style.display = "block";
        initGoogleSignIn();
        questions = examData.questions;
        sheetName = examData.sheetName;
        timeLimit = examData.timeLimit;
        document.getElementById("pdfFrame").src = examData.pdfLink;
        loadAnswers();
        answers = answers || new Array(questions.length);
      } else {
        document.body.innerHTML = "<h2 style='text-align: center; color: red;'>‚ùå B√†i t·∫≠p kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a!</h2>";
      }
    }
  </script>

</body>

</html>
